<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Atrapa la Comida ‚Äì Mejorado PRO</title>
<style>
  body {
    margin: 0;
    background: #000;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: Arial, sans-serif;
  }
  canvas {
    background: linear-gradient(180deg, #12141c, #1d2230, #12141c);
    background-size: 400% 400%;
    animation: fondo 6s infinite alternate ease-in-out;
    border: 3px solid #fff;
  }
  @keyframes fondo {
    0% { background-position: 0% 0%; }
    100% { background-position: 0% 100%; }
  }
  #ui, #menu, #gameover, #login, #ranking {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    display: none;
  }
  button {
    font-size: 22px;
    margin: 10px;
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
  }
  input { font-size:18px }
</style>
</head>
<body>

<div id="login" style="display:flex;flex-direction:column;justify-content:center;align-items:center;color:white;width:100%;height:100%;">
  <h1 style="font-size:32px;">Cuenta</h1>
  <div style="display:flex;gap:10px;flex-direction:column;align-items:center;">
    <input id="newUser" placeholder="Nuevo usuario" style="padding:10px;font-size:20px;border-radius:10px;margin:6px;">
    <input id="newPass" type="password" placeholder="Nueva contrase√±a" style="padding:10px;font-size:20px;border-radius:10px;margin:6px;">
    <button onclick="registerUser()">Registrar</button>

    <hr style="width:60%; margin:10px; border-color:rgba(255,255,255,0.2);">

    <input id="username" placeholder="Usuario" style="padding:10px;font-size:20px;border-radius:10px;margin:6px;">
    <input id="password" type="password" placeholder="Contrase√±a" style="padding:10px;font-size:20px;border-radius:10px;margin:6px;">
    <button onclick="userLogin()">Iniciar Sesi√≥n</button>
  </div>
</div>

<div id="menu" style="display:none;flex-direction:column;justify-content:center;align-items:center;color:white;width:100%;height:100%;">
  <h1 style="font-size:40px;">ATrapa LA COMIDA üçΩÔ∏è</h1>
  <img id="avatarPreview" src="" alt="avatar" style="width:100px;height:100px;border-radius:50%;border:3px solid white;object-fit:cover;margin:10px;">
  <p id="userLabel"></p>
  <p id="bestRecord"></p>
  <div style="display:flex;gap:8px;">
    <button onclick="iniciarJuego()">Jugar</button>
    <button onclick="mostrarRanking()">Tabla de L√≠deres</button>
    <button onclick="logout()">Cerrar sesi√≥n</button>
  </div>
</div>

<div id="ranking" style="display:none;flex-direction:column;justify-content:center;align-items:center;color:white;width:100%;height:100%;overflow:auto;">
  <h2>üèÜ Tabla de L√≠deres</h2>
  <div id="rankingList" style="text-align:center;font-size:20px;max-width:90%;"></div>
  <button onclick="volverMenuRanking()">Volver</button>
</div>

<div id="gameover" style="display:none;">
  <p style="font-size:35px;color:white;">¬°PERDISTE!</p>
  <p id="scoreFinal" style="color:white;"></p>
  <p id="highscore" style="color:white;"></p>
  <div style="display:flex;gap:8px;">
    <button onclick="reiniciarJuego()">Reintentar</button>
    <button onclick="volverMenu()">Salir</button>
  </div>
</div>

<canvas id="game" width="400" height="600"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

let jugador, objetos;
let usuario = null;
let usuariosDB = JSON.parse(localStorage.getItem("usuariosDB")) || {};
let puntos = 0, vidas = 3, nivel = 1;
let gameOver = false, iniciado = false;

// Emojis
const comidas = ["üçé", "üçî", "üçï", "üçå", "üç©", "üçü", "ü•¶", "üçó", "üåÆ", "üçí", "üç™"];
const bombas = ["üí£", "üî•", "üß®"]; 
const powerups = ["‚≠ê", "üõ°Ô∏è", "üê¢"];

// REGISTER (nuevo usuario)
function registerUser(){
  let u = document.getElementById("newUser").value.trim();
  let p = document.getElementById("newPass").value.trim();
  if(!u || !p){ alert("Completa usuario y contrase√±a"); return; }
  if(usuariosDB[u]){ alert("Ese usuario ya existe"); return; }

  let av = prompt("Pega URL de tu avatar (imagen) o deja vac√≠o para usar uno por defecto:", "");
  if(!av) av = "https://i.imgur.com/3XjC4QX.png";

  usuariosDB[u] = { pass: p, record: 0, avatar: av };
  localStorage.setItem("usuariosDB", JSON.stringify(usuariosDB));
  alert("Usuario creado. Ahora inicia sesi√≥n.");
}

// LOGIN (iniciar sesi√≥n)
function userLogin(){
  const name = document.getElementById("username").value.trim();
  const pass = document.getElementById("password").value;
  if(!name || !pass){ alert("Ingresa usuario y contrase√±a"); return; }
  if(!usuariosDB[name] || usuariosDB[name].pass !== pass){ alert("Datos incorrectos"); return; }
  usuario = name;
  // mostrar menu
  document.getElementById("login").style.display = "none";
  document.getElementById("menu").style.display = "flex";
  document.getElementById("userLabel").innerText = `Usuario: ${usuario}`;
  document.getElementById("avatarPreview").src = usuariosDB[usuario].avatar || "https://i.imgur.com/3XjC4QX.png";
  document.getElementById("bestRecord").innerText = `R√©cord: ${usuariosDB[usuario].record}`;
}

function logout(){
  usuario = null;
  document.getElementById("menu").style.display = "none";
  document.getElementById("login").style.display = "flex";
}

function iniciarJuego(){
  if(!usuario){ alert('Debes iniciar sesi√≥n'); return; }
  document.getElementById("menu").style.display = "none";
  puntos = 0; vidas = 3; nivel = 1;
  objetos = [];
  jugador = { x: 180, y: 550, size: 50, emoji: "üçΩÔ∏è", shield: false };
  gameOver = false;
  iniciado = true;
  document.getElementById('gameover').style.display = 'none';
}

function crearObjeto(tipo){
  return {
    x: Math.random()*360,
    y: -50,
    size: 40,
    speed: 3 + nivel*0.5 + Math.random()*1.5,
    tipo: tipo,
    emoji:
      tipo === "comida" ? comidas[Math.floor(Math.random()*comidas.length)] :
      tipo === "bomba" ? bombas[Math.floor(Math.random()*bombas.length)] :
      powerups[Math.floor(Math.random()*powerups.length)]
  };
}

function loop(){
  requestAnimationFrame(loop);
  if(!iniciado || gameOver) return;

  ctx.clearRect(0,0,400,600);

  if(Math.random() < 0.03) objetos.push(crearObjeto("comida"));
  if(Math.random() < 0.015) objetos.push(crearObjeto("bomba"));
  if(Math.random() < 0.005) objetos.push(crearObjeto("power"));

  objetos.forEach((o,i)=>{
    o.y += o.speed;

    if(o.y > 650) objetos.splice(i,1);

    dibujar(o);

    if(colision(jugador,o)){
      manejarColision(o,i);
    }
  });

  dibujar(jugador);

  ctx.fillStyle = 'white';
  ctx.font = '20px Arial';
  ctx.fillText(`Puntos: ${puntos}`, 10, 25);
  ctx.fillText(`Vidas: ${"‚ù§Ô∏è".repeat(vidas)}`, 260, 25);
  ctx.fillText(`Nivel: ${nivel}`, 10, 50);

  nivel = 1 + Math.floor(puntos/10);
}

function manejarColision(o,index){
  if(o.tipo === "comida"){
    puntos++;
    objetos.splice(index,1);
  }
  else if(o.tipo === "bomba"){
    if(jugador.shield){ jugador.shield = false; objetos.splice(index,1); return; }
    vidas--;
    objetos.splice(index,1);
    if(vidas <= 0) activarGameOver();
  }
  else if(o.tipo === "power"){
    if(o.emoji === "‚≠ê") puntos += 5;
    if(o.emoji === "üõ°Ô∏è") jugador.shield = true;
    if(o.emoji === "üê¢") objetos.forEach(e => e.speed *= 0.5);
    objetos.splice(index,1);
  }
}

function dibujar(o){
  ctx.font = o.size + "px Arial";
  ctx.fillText(o.emoji, o.x, o.y + o.size);
}

function colision(a,b){
  return a.x < b.x + b.size && a.x + a.size > b.x && a.y < b.y + b.size && a.y + a.size > b.y;
}

function activarGameOver(){
  gameOver = true;
  iniciado = false;
  document.getElementById("gameover").style.display = "flex";
  document.getElementById("scoreFinal").innerText = `Puntaje final: ${puntos}`;

  // Actualizar r√©cord del usuario si corresponde
  if(usuario){
    if(!usuariosDB[usuario]) usuariosDB[usuario] = { pass: "", record: 0, avatar: "https://i.imgur.com/3XjC4QX.png" };
    if(puntos > (usuariosDB[usuario].record || 0)){
      usuariosDB[usuario].record = puntos;
      localStorage.setItem("usuariosDB", JSON.stringify(usuariosDB));
    }
    document.getElementById("highscore").innerText = `R√©cord: ${usuariosDB[usuario].record}`;
  } else {
    document.getElementById("highscore").innerText = `R√©cord: -`;
  }
}

function reiniciarJuego(){ location.reload(); }

function mostrarRanking(){
  document.getElementById("menu").style.display = "none";
  document.getElementById("ranking").style.display = "flex";

  let r = Object.entries(usuariosDB).sort((a,b)=> (b[1].record||0) - (a[1].record||0));
  let html = "";
  r.forEach(([name,data],index)=>{
    html += `<p style=\"margin:6px;\">${index+1}. <img src='${data.avatar||"https://i.imgur.com/3XjC4QX.png"}' style='width:40px;height:40px;border-radius:50%;vertical-align:middle;margin-right:8px;'> <strong>${name}</strong> - ${data.record||0}</p>`;
  });
  document.getElementById("rankingList").innerHTML = html || "<p>No hay usuarios a√∫n</p>";
}

function volverMenuRanking(){
  document.getElementById("ranking").style.display = "none";
  document.getElementById("menu").style.display = "flex";
}

function volverMenu(){
  // desde gameover vuelve al men√∫ principal
  document.getElementById("gameover").style.display = "none";
  document.getElementById("menu").style.display = "flex";
}

canvas.addEventListener("mousemove", e => {
  const rect = canvas.getBoundingClientRect();
  if(jugador) jugador.x = e.clientX - rect.left - jugador.size/2;
});

canvas.addEventListener("touchmove", e => {
  const rect = canvas.getBoundingClientRect();
  if(jugador) jugador.x = e.touches[0].clientX - rect.left - jugador.size/2;
  e.preventDefault();
});

// Mostrar pantalla de login al cargar
window.addEventListener('load', ()=>{
  document.getElementById('login').style.display = 'flex';
  loop();
});

</script>
</body>
</html>
